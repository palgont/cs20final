<!DOCTYPE html>
<html>
    <head>
        <!-- URL: http://localhost:5500/midterm/index.html -->
        <title>NomNomNom</title>
        <!-- Link to external style sheet -->
        <link rel="stylesheet" href="styles.css">
        <!-- For Favicon -->
        <link rel="icon" type="image/x-icon" href="images/nomoriginal.png">
        <!-- For JQuery usage -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js" 
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" 
        crossorigin="anonymous"></script>
        <!--Font Styles-->
        <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap"
        rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Text:ital@0;1&display=swap"
        rel="stylesheet">
        <!-- For responsiveness -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!-- Google Sign-In client library -->
        <script src="https://accounts.google.com/gsi/client" async defer></script>
        <!-- Our script to load nav and handle sign-in -->
        <script src="nav.js" defer></script>
        <style>
            section img { /*top banner image*/
                width: 100%;
                height: 420px;
                object-fit: cover;
            }
            .top-description { /*title and short description*/
                max-width: 800px;
                margin: 20px auto;
                text-align: center;
                padding: 10px;
                font-family: "Open Sans", sans-serif;
            }
            
            .top-description h1 { /*title*/
                text-align: center;
                font-size:48px;
            }
            .top-description p { /*short description under title*/
                font-size:20px;
            }
            #token-message{
              color: #737070;
            }
            /* Nomly Chatbot */
            .nomly-container {
              display: flex;
              flex-direction: column;
              align-items: center;      /* center horizontally */
              width: 100%;
            }
            .chatbot-form {
              text-align: center;
              align-items: center;
              justify-content: center;
              display: flexblock;
            }
            #sendMessage {
              justify-content:right;
            }
            #chatbot-input {
              font-family: "Open Sans";
              font-size: 18px;
              padding:1vw;
              width:70vw;
              max-width:800px;
            }
            .chatbot-response {
              font-family: "Open Sans";
              font-size: 20px;
              width: 70vw;
              max-width: 800px;
              margin-top: .5rem;
              padding: 1rem;
              border:solid #49484885 1px;
              border-radius: 3px;
              background: #ffffffc3;
              height: auto;            /* remove any fixed height */
              overflow: visible;
              white-space: pre-wrap;
              word-break: break-word;
              box-sizing: border-box;
              display:none;
            }

            .spoonacular-description {
                max-width: 800px;
                margin: 20px auto;
                text-align: center;
                padding: 10px;
                font-family: "Open Sans", sans-serif;
                font-size:20px;
            }

            /* ingredient form */
            .form-container {
                max-width: 600px;
                margin: 40px auto;
                padding: 20px;
                font-family: "Open Sans", sans-serif;
                background: #f8f8f8;
                border-radius: 8px;
                box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
            }
            /* stack rows, gap between them */
            #ingredients-container {
                display: flex;
                flex-direction: column;
                row-gap: 0.75rem;
            }

            /* each input fills its row */
            .ingredient-row input {
                display: block;
                width: 100%;
                box-sizing: border-box;
                padding: 0.5rem;
                font-size: 1rem;
            }
            .buttons{
                display:flex;
                justify-content: center;
            }
            button {
                width: 30%;
                background-color: #50affd;
                color: white;
                padding: 10px;
                margin:10px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
            }
            #sendMessage {
                max-width: 200px;
            }

            /* recipe results */
            .recipe-results{
                text-align: center;
                align-items: center;

            }
            
        </style>
        
    </head>
    <body>
        <div id="top_bar">
            <!-- Header -->
            <header>
                <a href="index.html">
                    <div id = "img_container">
                        <img id="logo" src="images/nomoriginal.png">
                    </div>
                </a>
                <a href="index.html"><span id="title">NomNomNom</span></a>
            </header>
            <!-- Navagation Bar -->
            <div id="nav-placeholder"></div>
            
            <div id = "below_nav"></div>
        </div>
        <section>
             <img src="./images/chopping_board.jpg" alt="banner image">
        </section>

        <!-- Title & Description -->
        <div class="top-description">
            <h1>CreateaDish</h1>
            <p>
              Chat with <strong>Nomly</strong> to create a meal tailored to your
              ingredients and your preferences.
            </p>
            <p id="token-message">
              *Login and start chatting with Nomly — 5 free tokens every day!
            </p>
        </div>

        <!-- Nomly Chatbot Form -->
        <div class="nomly-container">
          <div class="chatbot-form">
            <input type="text" id="chatbot-input" Placeholder="Type your message...">
          </div>
          <button id="sendMessage">Send Message</button>
          <!-- Placeholder for Chabot Response -->
          <div class="chatbot-response" id="chatbot-response">
            ...
          </div>
        </div>

        <!-- Spoonacular API -->
        <div class="spoonacular-description">
          <p>
            Ran out of tokens?<br>
            Enter ingredients you have at home to find delicious recipes you can make.
          </p>
        </div>

        <!-- User Form with Ingredients -->
        <section class="form-container" id="form-container">
                <form id="recipe-form">
                        <div id="ingredients-container">
                          <div class="ingredient-row">
                            <input type="text" name="ingredient[]" placeholder="Ingredient 1">
                          </div>
                        </div>
                <div class="buttons">
                        <button type="button" id="add-ingredient">Add Ingredient</button>
                        <button type="submit">Submit</button>
                </div>
                </form>
                    
                <!-- dynamic form, add more ingredient inputs -->
                <script>
                        const container = document.getElementById('ingredients-container');
                        const addBtn = document.getElementById('add-ingredient');
                        let count = 1;

                        addBtn.addEventListener('click', () => {
                        count++;
                        // create row wrapper
                        const row = document.createElement('div');
                        row.className = 'ingredient-row';

                        // create input
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.name = 'ingredient[]';
                        input.placeholder = `Ingredient ${count}`;

                        row.appendChild(input);
                        container.appendChild(row);

                        // optional: scroll new input into view
                        input.scrollIntoView({ behavior: 'smooth' });
                        });
                </script>
        </section>


        <!-- Placeholder for Recipe Results -->
        <div class="recipe-results">
        </div>

        <!-- Footer -->
        <footer>
                <p>©NomNomNom &nbsp;|&nbsp;+1(212)-616-6300 &nbsp;| 
                    &nbsp; <a href="mailto:nomnomnom@gmail.com">nomnomnom@gmail.com</a></p>
            </footer>

        <!-- jQuery Script for Expanding Q&A -->
        <script>
            $(document).ready(function() {
                $(".question").click(function() {
                    $(this).next(".answer").slideToggle();
                    $(".answer").not($(this).next()).slideUp(); // Closes other answers when a new one is clicked
                });
            });
        </script>

<script>
  // === Gemini API Call (adapted from your Python reference) ===
  const GEMINI_API_KEY = 'AIzaSyAYLOHNikABjrKdFBuxuOMTVracWnf8pQ8';
  const MODEL = 'gemini-2.0-flash';
  const MAX_ATTEMPTS = 5;

  document
    .getElementById('sendMessage')
    .addEventListener('click', sendMessage);

  async function sendMessage() {
    const input = document.getElementById('chatbot-input');
    const respDiv = document.getElementById('chatbot-response');
    respDiv.style.display ='block';
    const userText = input.value.trim();
    if (!userText) return;

    // Build the prompt for chatbot
    const promptText = `You are Nomly, a friendly recipe assistant, chef, and nutritionist. Only answer
    recipe-related questions; otherwise politely decline. Your goal is to provide healthy and delicious
    advice, accordingly to a user's input. If a user asks for a recipe, only provide
    one recipe example according to their needs.

    Question: ${userText}
    `.trim();

    const payload = {
      contents: [
        { parts: [{ text: promptText }] }
      ],
      generationConfig: {
        temperature: 0.0,
        maxOutputTokens: 1000
      }
    };

    const url = 
      `https://generativelanguage.googleapis.com/v1beta/models/` +
      `${MODEL}:generateContent?key=${GEMINI_API_KEY}`;

    let data, response;
    for (let attempt = 0; attempt < MAX_ATTEMPTS; attempt++) {
      response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (response.status === 200) {
        data = await response.json();
        break;
      } else if (response.status === 429) {
        // wait longer per rate request
        const waitMs = 2 ** attempt * 1000;
        console.warn(`Rate limited. retrying in ${waitMs}ms…`);
        await new Promise(res => setTimeout(res, waitMs));
      } else {
        const text = await response.text();
        console.error(`Gemini error ${response.status}: ${text}`);
        respDiv.innerHTML += 
          `<div style="color:red"><b>Error:</b> ${text}</div>`;
        return;
      }
    }

    // Parse and display the reply
    const botReply = data?.candidates?.[0]?.content?.parts?.[0]?.text
                   || 'Sorry, I didn’t get a response.';
    console.log(botReply);

    const raw = botReply;  // the full string
    const html = raw.replace(/\*\*/g, '<br>');
    respDiv.innerHTML += `<div>${html}</div>`;

    // Clear input & keep focus
    input.value = '';
    input.focus();
  }


    // Spoonacular API Call
    (function() {
      const RAPI_KEY  = 'b0965f3214msh0dadb2ecd1d8345p1fadccjsnb12422b10e35';
      const RAPI_HOST = 'spoonacular-recipe-food-nutrition-v1.p.rapidapi.com';
      const ENDPOINT  = `https://${RAPI_HOST}/recipes/findByIngredients`;
  
      document.getElementById('recipe-form').addEventListener('submit', async function(e) {
        e.preventDefault();
  
        const inputs = document.querySelectorAll('input[name="ingredient[]"]');
        const ingredients = Array.from(inputs)
          .map(i => i.value.trim())
          .filter(v => v)
          .join(',');
  
        if (!ingredients) {
          return alert('Please enter at least one ingredient.');
        }
  
        const params = new URLSearchParams({
          ingredients,
          number: '3',
          ignorePantry: 'true',
          ranking: '1'
        });
  
        const url = `${ENDPOINT}?${params}`;
        try {
          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'X-RapidAPI-Key':  RAPI_KEY,
              'X-RapidAPI-Host': RAPI_HOST
            }
          });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const recipes = await response.json();
  
          // render into the page
          const resultsDiv = document.querySelector('.recipe-results');
          resultsDiv.innerHTML = '';  // clear old
  
          recipes.forEach(recipe => {
            const card = document.createElement('div');
            card.className = 'recipe-card';
            card.innerHTML = `
              <h3>${recipe.title}</h3>
              <img src="${recipe.image}" alt="${recipe.title}"
                   style="max-width:100%;height:auto;border-radius:8px;" />
              <p>Used ingredients: ${recipe.usedIngredientCount}</p>
              <p>Missing ingredients: ${recipe.missedIngredientCount}</p>
              <p>Instructions: ${recipe.instruction}</p>
            `;
            resultsDiv.appendChild(card);
          });
        } catch (err) {
          console.error('RapidAPI error:', err);
          alert('Failed to fetch recipes. See console for details.');
        }
      });
    })();
  </script>  
<<<<<<< HEAD
    
  </body>
=======
        
    </body>
>>>>>>> c15cdeeebfc470d07055cdf26a7e88d8c2d79413
</html>